{
    "sourceFile": "api/reminder.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 32,
            "patches": [
                {
                    "date": 1757269391263,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757270851006,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // /api/reminder.js\r\n-import { connectDB, Event } from \"../lib/db.js\";\r\n+import connectDB, { Event } from \"../lib/db.js\";\r\n import nodemailer from \"nodemailer\";\r\n \r\n export default async function handler(req, res) {\r\n   if (req.method !== \"POST\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n"
                },
                {
                    "date": 1757271049400,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,33 +1,34 @@\n // /api/reminder.js\r\n import connectDB, { Event } from \"../lib/db.js\";\r\n+import jwt from \"jsonwebtoken\";\r\n import nodemailer from \"nodemailer\";\r\n \r\n export default async function handler(req, res) {\r\n-  if (req.method !== \"POST\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  // Only allow GET for testing\r\n+  if (req.method !== \"GET\") {\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  }\r\n \r\n+  // Check Authorization header\r\n+  const authHeader = req.headers.authorization;\r\n+  if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\r\n+    return res.status(401).json({ msg: \"No token, auth denied\" });\r\n+  }\r\n+\r\n+  const token = authHeader.split(\" \")[1];\r\n+  let adminEmail;\r\n+  try {\r\n+    const decoded = jwt.verify(token, process.env.JWT_SECRET);\r\n+    adminEmail = decoded.admin.email;\r\n+  } catch (err) {\r\n+    return res.status(401).json({ msg: \"Token is not valid\" });\r\n+  }\r\n+\r\n+  // Connect to DB\r\n   await connectDB();\r\n \r\n   const now = new Date();\r\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n-  const events = await Event.find({\r\n-    status: \"CONFIRMED\",\r\n-    date: { $lte: fiveMinutesLater, $gte: now },\r\n-  });\r\n-\r\n-  const transporter = nodemailer.createTransport({\r\n-    service: \"gmail\",\r\n-    auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-  });\r\n-\r\n-  for (const event of events) {\r\n-    await transporter.sendMail({\r\n-      from: process.env.ADMIN_EMAIL,\r\n-      to: event.createdBy,\r\n-      subject: `Reminder: \"${event.title}\" event in 5 minutes`,\r\n-      text: `Your event \"${event.title}\" is scheduled at ${event.date}`,\r\n-    });\r\n-  }\r\n-\r\n-  return res.json({ sent: events.length });\r\n-}\r\n+  // Get events for this admin in next 5 minutes\r\n+  const events = await E\r\n"
                },
                {
                    "date": 1757271057922,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,5 +30,32 @@\n   const now = new Date();\r\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   // Get events for this admin in next 5 minutes\r\n-  const events = await E\r\n+  const events = await Event.find({\r\n+    status: \"CONFIRMED\",\r\n+    createdBy: adminEmail,\r\n+    date: { $lte: fiveMinutesLater, $gte: now },\r\n+  });\r\n+\r\n+  if (events.length === 0) {\r\n+    return res.json({ sent: 0 });\r\n+  }\r\n+\r\n+  // Setup nodemailer\r\n+  const transporter = nodemailer.createTransport({\r\n+    service: \"gmail\",\r\n+    auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+  });\r\n+\r\n+  // Send emails\r\n+  for (const event of events) {\r\n+    await transporter.sendMail({\r\n+      from: process.env.ADMIN_EMAIL,\r\n+      to: event.createdBy,\r\n+      subject: `Reminder: \"${event.title}\" event in 5 minutes`,\r\n+      text: `Your event \"${event.title}\" is scheduled at ${event.date}`,\r\n+    });\r\n+  }\r\n+\r\n+  return res.json({ sent: events.length });\r\n+}\r\n"
                },
                {
                    "date": 1757271676762,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,61 +1,71 @@\n // /api/reminder.js\r\n import connectDB, { Event } from \"../lib/db.js\";\r\n-import jwt from \"jsonwebtoken\";\r\n+import Job from \"../models/job.js\";\r\n import nodemailer from \"nodemailer\";\r\n \r\n-export default async function handler(req, res) {\r\n-  // Only allow GET for testing\r\n-  if (req.method !== \"GET\") {\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-  }\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+});\r\n \r\n-  // Check Authorization header\r\n-  const authHeader = req.headers.authorization;\r\n-  if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\r\n-    return res.status(401).json({ msg: \"No token, auth denied\" });\r\n-  }\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${date}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n \r\n-  const token = authHeader.split(\" \")[1];\r\n-  let adminEmail;\r\n-  try {\r\n-    const decoded = jwt.verify(token, process.env.JWT_SECRET);\r\n-    adminEmail = decoded.admin.email;\r\n-  } catch (err) {\r\n-    return res.status(401).json({ msg: \"Token is not valid\" });\r\n-  }\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n \r\n-  // Connect to DB\r\n   await connectDB();\r\n \r\n   const now = new Date();\r\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n-  // Get events for this admin in next 5 minutes\r\n   const events = await Event.find({\r\n-    status: \"CONFIRMED\",\r\n-    createdBy: adminEmail,\r\n     date: { $lte: fiveMinutesLater, $gte: now },\r\n   });\r\n \r\n-  if (events.length === 0) {\r\n-    return res.json({ sent: 0 });\r\n-  }\r\n+  let processed = 0;\r\n \r\n-  // Setup nodemailer\r\n-  const transporter = nodemailer.createTransport({\r\n-    service: \"gmail\",\r\n-    auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-  });\r\n-\r\n-  // Send emails\r\n   for (const event of events) {\r\n-    await transporter.sendMail({\r\n-      from: process.env.ADMIN_EMAIL,\r\n-      to: event.createdBy,\r\n-      subject: `Reminder: \"${event.title}\" event in 5 minutes`,\r\n-      text: `Your event \"${event.title}\" is scheduled at ${event.date}`,\r\n-    });\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\") {\r\n+        // Send reminder email\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+        // Create Job with SENT\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        // Create Job with FAILED\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed to process event ${event._id}:`, err);\r\n+      // Create Job with FAILED for any errors\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n   }\r\n \r\n-  return res.json({ sent: events.length });\r\n+  return res.json({ processed });\r\n }\r\n"
                },
                {
                    "date": 1757273211933,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,9 +22,9 @@\n \r\n   await connectDB();\r\n \r\n   const now = new Date();\r\n-  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+  //const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   const events = await Event.find({\r\n     date: { $lte: fiveMinutesLater, $gte: now },\r\n   });\r\n"
                },
                {
                    "date": 1757273218555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,72 @@\n+// /api/reminder.js\r\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+});\r\n+\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${date}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n+\r\n+  await connectDB();\r\n+\r\n+  const now = new Date();\r\n+  //const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+  const fiveMinutesLater = new Date(now.getTime() + 2 * 60000);\r\n+\r\n+  const events = await Event.find({\r\n+    date: { $lte: fiveMinutesLater, $gte: now },\r\n+  });\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\") {\r\n+        // Send reminder email\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+        // Create Job with SENT\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        // Create Job with FAILED\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed to process event ${event._id}:`, err);\r\n+      // Create Job with FAILED for any errors\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  return res.json({ processed });\r\n+}\r\n"
                },
                {
                    "date": 1757273843596,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,41 +12,41 @@\n   return transporter.sendMail({\r\n     from: process.env.ADMIN_EMAIL,\r\n     to,\r\n     subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${date}.\\n\\n- Event Dashboard`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n   });\r\n }\r\n \r\n export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  if (req.method !== \"GET\")\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n \r\n   await connectDB();\r\n \r\n   const now = new Date();\r\n-  //const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-  const fiveMinutesLater = new Date(now.getTime() + 2 * 60000);\r\n+  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n+  // Fetch events within next 5 minutes\r\n   const events = await Event.find({\r\n-    date: { $lte: fiveMinutesLater, $gte: now },\r\n+    date: { $gte: now, $lte: fiveMinutesLater },\r\n   });\r\n \r\n   let processed = 0;\r\n \r\n   for (const event of events) {\r\n     try {\r\n       if (event.status === \"CONFIRMED\") {\r\n-        // Send reminder email\r\n         await sendEmail(event.createdBy, event.title, event.date);\r\n-        // Create Job with SENT\r\n         await Job.create({\r\n           eventId: event._id,\r\n           createdOn: new Date().toISOString(),\r\n           sentTo: event.createdBy,\r\n           status: \"SENT\",\r\n         });\r\n       } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        // Create Job with FAILED\r\n         await Job.create({\r\n           eventId: event._id,\r\n           createdOn: new Date().toISOString(),\r\n           sentTo: event.createdBy,\r\n@@ -55,10 +55,9 @@\n         });\r\n       }\r\n       processed++;\r\n     } catch (err) {\r\n-      console.error(`Failed to process event ${event._id}:`, err);\r\n-      // Create Job with FAILED for any errors\r\n+      console.error(`Failed event ${event._id}:`, err);\r\n       await Job.create({\r\n         eventId: event._id,\r\n         createdOn: new Date().toISOString(),\r\n         sentTo: event.createdBy,\r\n@@ -69,75 +68,4 @@\n   }\r\n \r\n   return res.json({ processed });\r\n }\r\n-// /api/reminder.js\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-});\r\n-\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${date}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n-\r\n-  await connectDB();\r\n-\r\n-  const now = new Date();\r\n-  //const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-\r\n-  const events = await Event.find({\r\n-    date: { $lte: fiveMinutesLater, $gte: now },\r\n-  });\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      if (event.status === \"CONFIRMED\") {\r\n-        // Send reminder email\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n-        // Create Job with SENT\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        // Create Job with FAILED\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed to process event ${event._id}:`, err);\r\n-      // Create Job with FAILED for any errors\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  return res.json({ processed });\r\n-}\r\n"
                },
                {
                    "date": 1757274299639,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,15 +24,15 @@\n     return res.status(405).json({ msg: \"Method not allowed\" });\r\n \r\n   await connectDB();\r\n \r\n-  const now = new Date();\r\n-  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+  const now = new Date(); // in local time\r\n+const nowUTC = new Date(now.toISOString()); // convert to UTC\r\n+const fiveMinutesLaterUTC = new Date(nowUTC.getTime() + 5 * 60000);\r\n \r\n-  // Fetch events within next 5 minutes\r\n-  const events = await Event.find({\r\n-    date: { $gte: now, $lte: fiveMinutesLater },\r\n-  });\r\n+const events = await Event.find({\r\n+  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n+});\r\n \r\n   let processed = 0;\r\n \r\n   for (const event of events) {\r\n"
                },
                {
                    "date": 1757274608372,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,14 +24,14 @@\n     return res.status(405).json({ msg: \"Method not allowed\" });\r\n \r\n   await connectDB();\r\n \r\n-  const now = new Date(); // in local time\r\n-const nowUTC = new Date(now.toISOString()); // convert to UTC\r\n-const fiveMinutesLaterUTC = new Date(nowUTC.getTime() + 5 * 60000);\r\n+ const now = new Date();\r\n+const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n const events = await Event.find({\r\n-  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n+  date: { $gte: now, $lte: fiveMinutesLater },\r\n+  status: \"CONFIRMED\",\r\n });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757274619014,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n const events = await Event.find({\r\n   date: { $gte: now, $lte: fiveMinutesLater },\r\n-  status: \"CONFIRMED\",\r\n+  ,\r\n });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757274626024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,70 @@\n+// /api/reminder.js\r\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+});\r\n+\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\")\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+\r\n+  await connectDB();\r\n+\r\n+ const now = new Date();\r\n+const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+\r\n+const events = await Event.find({\r\n+  date: { $gte: now, $lte: fiveMinutesLater }\r\n+});\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\") {\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err);\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  return res.json({ processed });\r\n+}\r\n"
                },
                {
                    "date": 1757274917798,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,81 +27,15 @@\n \r\n  const now = new Date();\r\n const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n-const events = await Event.find({\r\n-  date: { $gte: now, $lte: fiveMinutesLater }\r\n-});\r\n+// Convert to UTC for MongoDB query\r\n+const nowUTC = new Date(now.toISOString());\r\n+const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n \r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      if (event.status === \"CONFIRMED\") {\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err);\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  return res.json({ processed });\r\n-}\r\n-// /api/reminder.js\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-});\r\n-\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\")\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-\r\n-  await connectDB();\r\n-\r\n- const now = new Date();\r\n-const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-\r\n const events = await Event.find({\r\n-  date: { $gte: now, $lte: fiveMinutesLater },\r\n-  ,\r\n+  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n+  status: \"CONFIRMED\",\r\n });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757274923823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,74 @@\n+// /api/reminder.js\r\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+});\r\n+\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\")\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+\r\n+  await connectDB();\r\n+\r\n+ const now = new Date();\r\n+const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+\r\n+// Convert to UTC for MongoDB query\r\n+const nowUTC = new Date(now.toISOString());\r\n+const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n+\r\n+const events = await Event.find({\r\n+  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC }\r\n+});\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\") {\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err);\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  return res.json({ processed });\r\n+}\r\n"
                },
                {
                    "date": 1757276992331,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-// /api/reminder.js\r\n+/* // /api/reminder.js\r\n import connectDB, { Event } from \"../lib/db.js\";\r\n import Job from \"../models/job.js\";\r\n import nodemailer from \"nodemailer\";\r\n \r\n@@ -71,79 +71,5 @@\n   }\r\n \r\n   return res.json({ processed });\r\n }\r\n-// /api/reminder.js\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-});\r\n-\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\")\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-\r\n-  await connectDB();\r\n-\r\n- const now = new Date();\r\n-const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-\r\n-// Convert to UTC for MongoDB query\r\n-const nowUTC = new Date(now.toISOString());\r\n-const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n-\r\n-const events = await Event.find({\r\n-  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n-  status: \"CONFIRMED\",\r\n-});\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      if (event.status === \"CONFIRMED\") {\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err);\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  return res.json({ processed });\r\n-}\r\n+ */\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757277241463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,75 @@\n+/* // /api/reminder.js\r\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n+});\r\n+\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\")\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+\r\n+  await connectDB();\r\n+\r\n+ const now = new Date();\r\n+const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+\r\n+// Convert to UTC for MongoDB query\r\n+const nowUTC = new Date(now.toISOString());\r\n+const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n+\r\n+const events = await Event.find({\r\n+  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC }\r\n+});\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\") {\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err);\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  return res.json({ processed });\r\n+}\r\n+ */\r\n"
                },
                {
                    "date": 1757277255739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-/* // /api/reminder.js\r\n+// /api/reminder.js\r\n import connectDB, { Event } from \"../lib/db.js\";\r\n import Job from \"../models/job.js\";\r\n import nodemailer from \"nodemailer\";\r\n \r\n@@ -71,80 +71,4 @@\n   }\r\n \r\n   return res.json({ processed });\r\n }\r\n- */\r\n-/* // /api/reminder.js\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-});\r\n-\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\")\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-\r\n-  await connectDB();\r\n-\r\n- const now = new Date();\r\n-const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-\r\n-// Convert to UTC for MongoDB query\r\n-const nowUTC = new Date(now.toISOString());\r\n-const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n-\r\n-const events = await Event.find({\r\n-  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC }\r\n-});\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      if (event.status === \"CONFIRMED\") {\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err);\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  return res.json({ processed });\r\n-}\r\n- */\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757440397489,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n-// /api/reminder.js\r\n import connectDB, { Event } from \"../lib/db.js\";\r\n import Job from \"../models/job.js\";\r\n import nodemailer from \"nodemailer\";\r\n+import { withAuth } from \"../lib/middleware.js\";\r\n \r\n const transporter = nodemailer.createTransport({\r\n   service: \"gmail\",\r\n   auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n@@ -18,24 +18,25 @@\n     ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n   });\r\n }\r\n \r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\")\r\n+async function handler(req, res) {\r\n+  if (req.method !== \"GET\") {\r\n     return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  }\r\n \r\n   await connectDB();\r\n \r\n- const now = new Date();\r\n-const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+  const now = new Date();\r\n+  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n-// Convert to UTC for MongoDB query\r\n-const nowUTC = new Date(now.toISOString());\r\n-const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n+  // Convert to UTC for MongoDB query\r\n+  const nowUTC = new Date(now.toISOString());\r\n+  const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n \r\n-const events = await Event.find({\r\n-  date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC }\r\n-});\r\n+  const events = await Event.find({\r\n+    date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n+  });\r\n \r\n   let processed = 0;\r\n \r\n   for (const event of events) {\r\n@@ -71,4 +72,7 @@\n   }\r\n \r\n   return res.json({ processed });\r\n }\r\n+\r\n+// âœ… Wrap withAuth so CORS + JWT are applied\r\n+export default withAuth(handler);\r\n"
                },
                {
                    "date": 1757619368527,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,78 +0,0 @@\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-import { withAuth } from \"../lib/middleware.js\";\r\n-\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n-});\r\n-\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-async function handler(req, res) {\r\n-  if (req.method !== \"GET\") {\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-  }\r\n-\r\n-  await connectDB();\r\n-\r\n-  const now = new Date();\r\n-  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n-\r\n-  // Convert to UTC for MongoDB query\r\n-  const nowUTC = new Date(now.toISOString());\r\n-  const fiveMinutesLaterUTC = new Date(fiveMinutesLater.toISOString());\r\n-\r\n-  const events = await Event.find({\r\n-    date: { $gte: nowUTC, $lte: fiveMinutesLaterUTC },\r\n-  });\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      if (event.status === \"CONFIRMED\") {\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err);\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  return res.json({ processed });\r\n-}\r\n-\r\n-// âœ… Wrap withAuth so CORS + JWT are applied\r\n-export default withAuth(handler);\r\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757623571041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,90 @@\n-\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+// Configure Nodemailer\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: {\r\n+    user: process.env.ADMIN_EMAIL,\r\n+    pass: process.env.ADMIN_PASS,\r\n+  },\r\n+});\r\n+\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\") {\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  }\r\n+\r\n+  // ðŸ”’ Secure with CRON_SECRET\r\n+  const { secret } = req.query;\r\n+  if (secret !== process.env.CRON_SECRET) {\r\n+    return res.status(403).json({ msg: \"Forbidden\" });\r\n+  }\r\n+\r\n+  await connectDB();\r\n+\r\n+  const now = new Date();\r\n+  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n+\r\n+  // Query events happening within the next 5 minutes\r\n+  const events = await Event.find({\r\n+    date: { $gte: now, $lte: fiveMinutesLater },\r\n+    //reminderSent: { $ne: true }, // only events not yet reminded\r\n+  });\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      if (event.status === \"CONFIRMED\" && !event.reminderSent) {\r\n+        // Send email\r\n+        await sendEmail(event.createdBy, event.title, event.date);\r\n+\r\n+        // Mark event as reminded\r\n+        event.reminderSent = true;\r\n+        await event.save();\r\n+\r\n+        // Log success\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"SENT\",\r\n+        });\r\n+      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n+        // Log cancellation\r\n+        await Job.create({\r\n+          eventId: event._id,\r\n+          createdOn: new Date().toISOString(),\r\n+          sentTo: event.createdBy,\r\n+          status: \"FAILED\",\r\n+          motifFailure: event.status,\r\n+        });\r\n+      }\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err.message);\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  return res.json({ processed, checked: events.length });\r\n+}\r\n"
                },
                {
                    "date": 1757623606457,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,10 +39,10 @@\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n-    date: { $gte: now, $lte: fiveMinutesLater },\r\n-    //reminderSent: { $ne: true }, // only events not yet reminded\r\n+    //date: { $gte: now, $lte: fiveMinutesLater },\r\n+    reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757623683669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,10 +39,10 @@\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n-    //date: { $gte: now, $lte: fiveMinutesLater },\r\n-    reminderSent: { $ne: true }, // only events not yet reminded\r\n+    date: { $gte: now, $lte: fiveMinutesLater },\r\n+    // reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757623951146,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,9 +39,9 @@\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n-    date: { $gte: now, $lte: fiveMinutesLater },\r\n+    status: \"CONFIRMED\",\r\n     // reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n"
                },
                {
                    "date": 1757625620189,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,9 +40,9 @@\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n     status: \"CONFIRMED\",\r\n-    // reminderSent: { $ne: true }, // only events not yet reminded\r\n+     reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757625626113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,9 +40,9 @@\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n     status: \"CONFIRMED\",\r\n-     reminderSent: { $ne: true }, // only events not yet reminded\r\n+    reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757625631953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,9 +39,9 @@\n   const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n   // Query events happening within the next 5 minutes\r\n   const events = await Event.find({\r\n-    status: \"CONFIRMED\",\r\n+    date: { $gte: now, $lte: fiveMinutesLater },\r\n     reminderSent: { $ne: true }, // only events not yet reminded\r\n   });\r\n \r\n   let processed = 0;\r\n"
                },
                {
                    "date": 1757626354859,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,8 +10,9 @@\n     pass: process.env.ADMIN_PASS,\r\n   },\r\n });\r\n \r\n+// Send email function\r\n async function sendEmail(to, title, date) {\r\n   return transporter.sendMail({\r\n     from: process.env.ADMIN_EMAIL,\r\n     to,\r\n@@ -35,48 +36,48 @@\n \r\n   await connectDB();\r\n \r\n   const now = new Date();\r\n-  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n \r\n-  // Query events happening within the next 5 minutes\r\n+  // Reminder window: 5 minutes ahead Â± 1 minute\r\n+  const reminderTime = new Date(now.getTime() + 5 * 60000);\r\n+  const reminderWindowEnd = new Date(reminderTime.getTime() + 60000); // 1-minute window\r\n+\r\n+  console.log(\"Checking for events between\", reminderTime, \"and\", reminderWindowEnd);\r\n+\r\n   const events = await Event.find({\r\n-    date: { $gte: now, $lte: fiveMinutesLater },\r\n-    reminderSent: { $ne: true }, // only events not yet reminded\r\n+    date: { $gte: reminderTime, $lt: reminderWindowEnd },\r\n+    status: \"CONFIRMED\",\r\n+    reminderSent: { $ne: true },\r\n   });\r\n \r\n+  console.log(`Found ${events.length} events to remind`);\r\n+\r\n   let processed = 0;\r\n \r\n   for (const event of events) {\r\n     try {\r\n-      if (event.status === \"CONFIRMED\" && !event.reminderSent) {\r\n-        // Send email\r\n-        await sendEmail(event.createdBy, event.title, event.date);\r\n+      console.log(`Sending reminder for event: ${event.title} (${event._id})`);\r\n \r\n-        // Mark event as reminded\r\n-        event.reminderSent = true;\r\n-        await event.save();\r\n+      // Send email\r\n+      await sendEmail(event.createdBy, event.title, event.date);\r\n \r\n-        // Log success\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"SENT\",\r\n-        });\r\n-      } else if (event.status === \"DELETED\" || event.status === \"CANCELLED\") {\r\n-        // Log cancellation\r\n-        await Job.create({\r\n-          eventId: event._id,\r\n-          createdOn: new Date().toISOString(),\r\n-          sentTo: event.createdBy,\r\n-          status: \"FAILED\",\r\n-          motifFailure: event.status,\r\n-        });\r\n-      }\r\n+      // Mark as reminded\r\n+      event.reminderSent = true;\r\n+      await event.save();\r\n+\r\n+      // Log success in Job collection\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"SENT\",\r\n+      });\r\n+\r\n       processed++;\r\n     } catch (err) {\r\n       console.error(`Failed event ${event._id}:`, err.message);\r\n+\r\n       await Job.create({\r\n         eventId: event._id,\r\n         createdOn: new Date().toISOString(),\r\n         sentTo: event.createdBy,\r\n@@ -85,6 +86,9 @@\n       });\r\n     }\r\n   }\r\n \r\n-  return res.json({ processed, checked: events.length });\r\n+  const response = { processed, checked: events.length };\r\n+  console.log(\"API response:\", response);\r\n+\r\n+  return res.json(response);\r\n }\r\n"
                },
                {
                    "date": 1757627525634,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,11 +37,14 @@\n   await connectDB();\r\n \r\n   const now = new Date();\r\n \r\n-  // Reminder window: 5 minutes ahead Â± 1 minute\r\n-  const reminderTime = new Date(now.getTime() + 5 * 60000);\r\n-  const reminderWindowEnd = new Date(reminderTime.getTime() + 60000); // 1-minute window\r\n+// Check events where reminder should be sent now\r\n+const events = await Event.find({\r\n+  status: \"CONFIRMED\",\r\n+  reminderSent: { $ne: true },\r\n+  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n+});\r\n \r\n   console.log(\"Checking for events between\", reminderTime, \"and\", reminderWindowEnd);\r\n \r\n   const events = await Event.find({\r\n"
                },
                {
                    "date": 1757627556746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,25 +35,9 @@\n   }\r\n \r\n   await connectDB();\r\n \r\n-  const now = new Date();\r\n \r\n-// Check events where reminder should be sent now\r\n-const events = await Event.find({\r\n-  status: \"CONFIRMED\",\r\n-  reminderSent: { $ne: true },\r\n-  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n-});\r\n-\r\n-  console.log(\"Checking for events between\", reminderTime, \"and\", reminderWindowEnd);\r\n-\r\n-  const events = await Event.find({\r\n-    date: { $gte: reminderTime, $lt: reminderWindowEnd },\r\n-    status: \"CONFIRMED\",\r\n-    reminderSent: { $ne: true },\r\n-  });\r\n-\r\n   console.log(`Found ${events.length} events to remind`);\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757627564502,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,9 +35,16 @@\n   }\r\n \r\n   await connectDB();\r\n \r\n+  const now = new Date();\r\n \r\n+  // Check events where reminder should be sent now\r\n+const events = await Event.find({\r\n+  status: \"CONFIRMED\",\r\n+  reminderSent: { $ne: true },\r\n+  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n+});\r\n   console.log(`Found ${events.length} events to remind`);\r\n \r\n   let processed = 0;\r\n \r\n"
                },
                {
                    "date": 1757627571718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,88 @@\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+// Configure Nodemailer\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: {\r\n+    user: process.env.ADMIN_EMAIL,\r\n+    pass: process.env.ADMIN_PASS,\r\n+  },\r\n+});\r\n+\r\n+// Send email function\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\") {\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  }\r\n+\r\n+  // ðŸ”’ Secure with CRON_SECRET\r\n+  const { secret } = req.query;\r\n+  if (secret !== process.env.CRON_SECRET) {\r\n+    return res.status(403).json({ msg: \"Forbidden\" });\r\n+  }\r\n+\r\n+  await connectDB();\r\n+\r\n+  const now = new Date();\r\n+\r\n+  // Check events where reminder should be sent now\r\n+  const events = await Event.find({\r\n+          status: \"CONFIRMED\",\r\n+          reminderSent: { $ne: true },\r\n+  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n+});\r\n+  console.log(`Found ${events.length} events to remind`);\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      console.log(`Sending reminder for event: ${event.title} (${event._id})`);\r\n+\r\n+      // Send email\r\n+      await sendEmail(event.createdBy, event.title, event.date);\r\n+\r\n+      // Mark as reminded\r\n+      event.reminderSent = true;\r\n+      await event.save();\r\n+\r\n+      // Log success in Job collection\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"SENT\",\r\n+      });\r\n+\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err.message);\r\n+\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  const response = { processed, checked: events.length };\r\n+  console.log(\"API response:\", response);\r\n+\r\n+  return res.json(response);\r\n+}\r\n"
                },
                {
                    "date": 1757627579610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,87 @@\n+import connectDB, { Event } from \"../lib/db.js\";\r\n+import Job from \"../models/job.js\";\r\n+import nodemailer from \"nodemailer\";\r\n+\r\n+// Configure Nodemailer\r\n+const transporter = nodemailer.createTransport({\r\n+  service: \"gmail\",\r\n+  auth: {\r\n+    user: process.env.ADMIN_EMAIL,\r\n+    pass: process.env.ADMIN_PASS,\r\n+  },\r\n+});\r\n+\r\n+// Send email function\r\n+async function sendEmail(to, title, date) {\r\n+  return transporter.sendMail({\r\n+    from: process.env.ADMIN_EMAIL,\r\n+    to,\r\n+    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n+    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n+      date\r\n+    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+  });\r\n+}\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"GET\") {\r\n+    return res.status(405).json({ msg: \"Method not allowed\" });\r\n+  }\r\n+\r\n+  // ðŸ”’ Secure with CRON_SECRET\r\n+  const { secret } = req.query;\r\n+  if (secret !== process.env.CRON_SECRET) {\r\n+    return res.status(403).json({ msg: \"Forbidden\" });\r\n+  }\r\n+\r\n+  await connectDB();\r\n+\r\n+  const now = new Date();\r\n+\r\n+  // Check events where reminder should be sent now\r\n+  const events = await Event.find({\r\n+          status: \"CONFIRMED\",\r\n+          reminderSent: { $ne: true },\r\n+          date: { $lte: new Date(now.getTime() + 5*60000) },\r\n+  console.log(`Found ${events.length} events to remind`);\r\n+\r\n+  let processed = 0;\r\n+\r\n+  for (const event of events) {\r\n+    try {\r\n+      console.log(`Sending reminder for event: ${event.title} (${event._id})`);\r\n+\r\n+      // Send email\r\n+      await sendEmail(event.createdBy, event.title, event.date);\r\n+\r\n+      // Mark as reminded\r\n+      event.reminderSent = true;\r\n+      await event.save();\r\n+\r\n+      // Log success in Job collection\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"SENT\",\r\n+      });\r\n+\r\n+      processed++;\r\n+    } catch (err) {\r\n+      console.error(`Failed event ${event._id}:`, err.message);\r\n+\r\n+      await Job.create({\r\n+        eventId: event._id,\r\n+        createdOn: new Date().toISOString(),\r\n+        sentTo: event.createdBy,\r\n+        status: \"FAILED\",\r\n+        motifFailure: err.message,\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  const response = { processed, checked: events.length };\r\n+  console.log(\"API response:\", response);\r\n+\r\n+  return res.json(response);\r\n+}\r\n"
                },
                {
                    "date": 1757627591793,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,97 +41,10 @@\n   // Check events where reminder should be sent now\r\n   const events = await Event.find({\r\n           status: \"CONFIRMED\",\r\n           reminderSent: { $ne: true },\r\n-          date: { $lte: new Date(now.getTime() + 5*60000) },\r\n-  console.log(`Found ${events.length} events to remind`);\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      console.log(`Sending reminder for event: ${event.title} (${event._id})`);\r\n-\r\n-      // Send email\r\n-      await sendEmail(event.createdBy, event.title, event.date);\r\n-\r\n-      // Mark as reminded\r\n-      event.reminderSent = true;\r\n-      await event.save();\r\n-\r\n-      // Log success in Job collection\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"SENT\",\r\n-      });\r\n-\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err.message);\r\n-\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  const response = { processed, checked: events.length };\r\n-  console.log(\"API response:\", response);\r\n-\r\n-  return res.json(response);\r\n-}\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-// Configure Nodemailer\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: {\r\n-    user: process.env.ADMIN_EMAIL,\r\n-    pass: process.env.ADMIN_PASS,\r\n-  },\r\n-});\r\n-\r\n-// Send email function\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n+          date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n   });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\") {\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-  }\r\n-\r\n-  // ðŸ”’ Secure with CRON_SECRET\r\n-  const { secret } = req.query;\r\n-  if (secret !== process.env.CRON_SECRET) {\r\n-    return res.status(403).json({ msg: \"Forbidden\" });\r\n-  }\r\n-\r\n-  await connectDB();\r\n-\r\n-  const now = new Date();\r\n-\r\n-  // Check events where reminder should be sent now\r\n-  const events = await Event.find({\r\n-          status: \"CONFIRMED\",\r\n-          reminderSent: { $ne: true },\r\n-  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n-});\r\n   console.log(`Found ${events.length} events to remind`);\r\n \r\n   let processed = 0;\r\n \r\n@@ -172,92 +85,4 @@\n   console.log(\"API response:\", response);\r\n \r\n   return res.json(response);\r\n }\r\n-import connectDB, { Event } from \"../lib/db.js\";\r\n-import Job from \"../models/job.js\";\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-// Configure Nodemailer\r\n-const transporter = nodemailer.createTransport({\r\n-  service: \"gmail\",\r\n-  auth: {\r\n-    user: process.env.ADMIN_EMAIL,\r\n-    pass: process.env.ADMIN_PASS,\r\n-  },\r\n-});\r\n-\r\n-// Send email function\r\n-async function sendEmail(to, title, date) {\r\n-  return transporter.sendMail({\r\n-    from: process.env.ADMIN_EMAIL,\r\n-    to,\r\n-    subject: `Reminder: \"${title}\" event in 5 minutes`,\r\n-    text: `Hello,\\n\\nThis is a reminder for your event: \"${title}\" scheduled at ${new Date(\r\n-      date\r\n-    ).toLocaleString()}.\\n\\n- Event Dashboard`,\r\n-  });\r\n-}\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"GET\") {\r\n-    return res.status(405).json({ msg: \"Method not allowed\" });\r\n-  }\r\n-\r\n-  // ðŸ”’ Secure with CRON_SECRET\r\n-  const { secret } = req.query;\r\n-  if (secret !== process.env.CRON_SECRET) {\r\n-    return res.status(403).json({ msg: \"Forbidden\" });\r\n-  }\r\n-\r\n-  await connectDB();\r\n-\r\n-  const now = new Date();\r\n-\r\n-  // Check events where reminder should be sent now\r\n-const events = await Event.find({\r\n-  status: \"CONFIRMED\",\r\n-  reminderSent: { $ne: true },\r\n-  date: { $lte: new Date(now.getTime() + 5*60000) }, // event is within next 5 minutes\r\n-});\r\n-  console.log(`Found ${events.length} events to remind`);\r\n-\r\n-  let processed = 0;\r\n-\r\n-  for (const event of events) {\r\n-    try {\r\n-      console.log(`Sending reminder for event: ${event.title} (${event._id})`);\r\n-\r\n-      // Send email\r\n-      await sendEmail(event.createdBy, event.title, event.date);\r\n-\r\n-      // Mark as reminded\r\n-      event.reminderSent = true;\r\n-      await event.save();\r\n-\r\n-      // Log success in Job collection\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"SENT\",\r\n-      });\r\n-\r\n-      processed++;\r\n-    } catch (err) {\r\n-      console.error(`Failed event ${event._id}:`, err.message);\r\n-\r\n-      await Job.create({\r\n-        eventId: event._id,\r\n-        createdOn: new Date().toISOString(),\r\n-        sentTo: event.createdBy,\r\n-        status: \"FAILED\",\r\n-        motifFailure: err.message,\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n-  const response = { processed, checked: events.length };\r\n-  console.log(\"API response:\", response);\r\n-\r\n-  return res.json(response);\r\n-}\r\n"
                }
            ],
            "date": 1757269391263,
            "name": "Commit-0",
            "content": "// /api/reminder.js\r\nimport { connectDB, Event } from \"../lib/db.js\";\r\nimport nodemailer from \"nodemailer\";\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== \"POST\") return res.status(405).json({ msg: \"Method not allowed\" });\r\n\r\n  await connectDB();\r\n\r\n  const now = new Date();\r\n  const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);\r\n\r\n  const events = await Event.find({\r\n    status: \"CONFIRMED\",\r\n    date: { $lte: fiveMinutesLater, $gte: now },\r\n  });\r\n\r\n  const transporter = nodemailer.createTransport({\r\n    service: \"gmail\",\r\n    auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_PASS },\r\n  });\r\n\r\n  for (const event of events) {\r\n    await transporter.sendMail({\r\n      from: process.env.ADMIN_EMAIL,\r\n      to: event.createdBy,\r\n      subject: `Reminder: \"${event.title}\" event in 5 minutes`,\r\n      text: `Your event \"${event.title}\" is scheduled at ${event.date}`,\r\n    });\r\n  }\r\n\r\n  return res.json({ sent: events.length });\r\n}\r\n"
        }
    ]
}